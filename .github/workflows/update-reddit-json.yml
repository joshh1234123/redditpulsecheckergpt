name: Update r/programmatic JSON

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      SCRIPT_PATH: ./.github/workflows/fetch_append_r_programmatic.py
      OUTPUT_FILE: programmatic_complete_for_llm.json
      SLICE_FILE: programmatic_last_250.json
      SHARDS_DIR: shards
      MANIFEST_FILE: manifest.json

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Validate secrets
        run: |
          [ -n "${{ secrets.REDDIT_CLIENT_ID }}" ] || { echo "Missing REDDIT_CLIENT_ID"; exit 1; }
          [ -n "${{ secrets.REDDIT_CLIENT_SECRET }}" ] || { echo "Missing REDDIT_CLIENT_SECRET"; exit 1; }

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install praw

      - name: Run incremental fetch
        env:
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
        run: python "${{ env.SCRIPT_PATH }}"

      - name: Verify DB exists
        run: |
          test -f "${OUTPUT_FILE}" || { echo "Expected ${OUTPUT_FILE} but it does not exist"; exit 1; }
          echo "DB size:"
          wc -c "${OUTPUT_FILE}" || true
          echo "DB preview:"
          head -n 40 "${OUTPUT_FILE}" || true

      - name: Build lightweight slice
        run: |
          python - << 'PY'
          import json, os
          SRC = os.environ["OUTPUT_FILE"]
          OUT = os.environ["SLICE_FILE"]
          N = 250
          with open(SRC, "r", encoding="utf-8") as f:
            db = json.load(f)
          items = db.get("discussions") or db.get("items") or []
          items = items[-N:]
          slim = {
            "metadata": {
              "source": (db.get("metadata", {}) or {}).get("source", "Reddit r/programmatic"),
              "slice_size": len(items)
            },
            "discussions": items
          }
          with open(OUT, "w", encoding="utf-8") as f:
            json.dump(slim, f, ensure_ascii=False, indent=2)
          print(f"Wrote {OUT} with {len(items)} posts")
          PY

      - name: Build shards and manifest
        run: |
          python - << 'PY'
          import json, os
          from pathlib import Path
          from datetime import datetime, timezone

          ROOT = Path(".")
          DB_FILE = ROOT / os.environ["OUTPUT_FILE"]
          SHARDS_DIR = ROOT / os.environ["SHARDS_DIR"]
          MANIFEST_FILE = ROOT / os.environ["MANIFEST_FILE"]
          SHARDS_DIR.mkdir(exist_ok=True)

          def month_key(ts):
            dt = datetime.fromtimestamp(float(ts or 0), tz=timezone.utc)
            return f"{dt.year:04d}-{dt.month:02d}"

          with open(DB_FILE, "r", encoding="utf-8") as f:
            db = json.load(f)
          items = db.get("discussions") or db.get("items") or []

          buckets = {}
          for p in items:
            ts = float(p.get("created_utc", 0) or 0)
            mk = month_key(ts)
            buckets.setdefault(mk, []).append(p)

          manifest = {
            "source": "Reddit r/programmatic",
            "shards": []
          }

          for mk in sorted(buckets.keys()):
            shard_items = sorted(buckets[mk], key=lambda r: float(r.get("created_utc", 0) or 0))
            out_path = SHARDS_DIR / f"{mk}.json"
            with open(out_path, "w", encoding="utf-8") as f:
              json.dump({"discussions": shard_items}, f, ensure_ascii=False, indent=2)
            first_ts = shard_items[0].get("created_utc", 0)
            last_ts  = shard_items[-1].get("created_utc", 0)
            manifest["shards"].append({
              "file": f"{mk}.json",
              "count": len(shard_items),
              "start_created_utc": first_ts,
              "end_created_utc": last_ts
            })

          with open(MANIFEST_FILE, "w", encoding="utf-8") as f:
            json.dump(manifest, f, ensure_ascii=False, indent=2)

          print(f"Wrote {len(manifest['shards'])} shards and {MANIFEST_FILE.name}")
          PY

      - name: Stage changes
        run: |
          git add "${OUTPUT_FILE}" "${SLICE_FILE}" "${MANIFEST_FILE}" "${SHARDS_DIR}/" || true
          git status --porcelain

      - name: Commit and push if changed
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            echo "Changes detected. Committing."
            git commit -m "Update DB, slice, and shards"
            git push
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: r-programmatic-outputs
          path: |
            ${{ env.OUTPUT_FILE }}
            ${{ env.SLICE_FILE }}
            ${{ env.MANIFEST_FILE }}
            ${{ env.SHARDS_DIR }}/*.json
          retention-days: 3
