name: Update r/programmatic JSON

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

concurrency:
  group: reddit-json
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      SCRIPT_PATH: ./.github/workflows/fetch_append_r_programmatic.py
      DB_FILE: programmatic_complete_for_llm.json
      SLICE_FILE: programmatic_last_100_meta.json
      MANIFEST_FILE: manifest.json
      META_DIR: meta
      THREADS_DIR: threads

    steps:
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate secrets
        run: |
          [ -n "${{ secrets.REDDIT_CLIENT_ID }}" ] || { echo "Missing REDDIT_CLIENT_ID"; exit 1; }
          [ -n "${{ secrets.REDDIT_CLIENT_SECRET }}" ] || { echo "Missing REDDIT_CLIENT_SECRET"; exit 1; }

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install praw

      - name: Run incremental fetch
        env:
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
        run: python "${{ env.SCRIPT_PATH }}"

      - name: Verify DB exists
        run: |
          test -f "${DB_FILE}" || { echo "Expected ${DB_FILE} but it does not exist"; exit 1; }
          echo "DB size:"
          wc -c "${DB_FILE}" || true

      - name: Build lightweight slice (no comments, last 100)
        run: |
          python - << 'PY'
          import json, os
          SRC = os.environ["DB_FILE"]
          OUT = os.environ["SLICE_FILE"]
          N = 100
          with open(SRC, "r", encoding="utf-8") as f:
            db = json.load(f)
          items = db.get("discussions") or db.get("items") or []
          items = items[-N:]
          meta_items = []
          for p in items:
            q = dict(p)
            q.pop("comments", None)
            meta_items.append(q)
          slim = {
            "metadata": {
              "source": (db.get("metadata", {}) or {}).get("source", "Reddit r/programmatic"),
              "slice_size": len(meta_items),
              "comments_included": False
            },
            "discussions": meta_items
          }
          with open(OUT, "w", encoding="utf-8") as f:
            json.dump(slim, f, ensure_ascii=False, indent=2)
          print(f"Wrote {OUT} with {len(meta_items)} posts (no comments)")
          PY

      - name: Build monthly META and per-post THREAD files
        run: |
          python - << 'PY'
          import json, os, re
          from pathlib import Path
          from datetime import datetime, timezone

          ROOT = Path(".")
          DB_FILE = ROOT / os.environ["DB_FILE"]
          META_DIR = ROOT / os.environ["META_DIR"]
          THREADS_DIR = ROOT / os.environ["THREADS_DIR"]
          MANIFEST_FILE = ROOT / os.environ["MANIFEST_FILE"]
          META_DIR.mkdir(exist_ok=True)
          THREADS_DIR.mkdir(exist_ok=True)

          def month_key(ts):
            dt = datetime.fromtimestamp(float(ts or 0), tz=timezone.utc)
            return f"{dt.year:04d}-{dt.month:02d}"

          with open(DB_FILE, "r", encoding="utf-8") as f:
            db = json.load(f)
          items = db.get("discussions") or db.get("items") or []

          buckets = {}
          for p in items:
            ts = float(p.get("created_utc", 0) or 0)
            mk = month_key(ts)
            buckets.setdefault(mk, []).append(p)

          manifest = {
            "source": "Reddit r/programmatic",
            "months": []
          }

          for mk in sorted(buckets.keys()):
            month_posts = sorted(buckets[mk], key=lambda r: float(r.get("created_utc", 0) or 0))

            # META file without comments
            meta_out = META_DIR / f"{mk}.json"
            meta_discussions = []
            for p in month_posts:
              q = dict(p)
              q.pop("comments", None)
              meta_discussions.append(q)
            with open(meta_out, "w", encoding="utf-8") as f:
              json.dump({"discussions": meta_discussions}, f, ensure_ascii=False, indent=2)

            # THREAD files with sanitized filenames
            for p in month_posts:
              pid = p.get("id") or ""
              if not pid:
                fallback = (p.get("url", "") + "|" + str(p.get("created_utc", "")))
                pid = re.sub(r'[^A-Za-z0-9._-]+', '-', fallback).strip('-')[:120]
              thread_path = THREADS_DIR / f"{pid}.json"
              thread_doc = {
                "id": p.get("id"),
                "title": p.get("title"),
                "permalink": p.get("permalink", p.get("url")),
                "created_utc": p.get("created_utc"),
                "num_comments": p.get("num_comments"),
                "comments": p.get("comments", [])
              }
              with open(thread_path, "w", encoding="utf-8") as f:
                json.dump(thread_doc, f, ensure_ascii=False, indent=2)

            manifest["months"].append({
              "month": mk,
              "count": len(month_posts),
              "meta_file": f"{mk}.json"
            })

          with open(MANIFEST_FILE, "w", encoding="utf-8") as f:
            json.dump(manifest, f, ensure_ascii=False, indent=2)

          print(f"Wrote {len(manifest['months'])} monthly META files and per-post THREAD files")
          PY

      - name: Commit and push if changed (stash, rebase, retry)
        run: |
          set -e
          BRANCH="${GITHUB_REF_NAME:-main}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Stash all local changes before pulling
          git add -A
          git stash push -u -m "autostash-before-pull" || true

          # Rebase on latest remote
          git fetch origin "${BRANCH}"
          git pull --rebase origin "${BRANCH}" || (git rebase --abort && git pull --no-rebase origin "${BRANCH}")

          # Re-apply our generated changes
          # If there is no stash, this will be a no-op
          if git stash list | grep -q "autostash-before-pull"; then
            git stash pop || true
          fi

          # Stage only the generated files
          git add "${DB_FILE}" "${SLICE_FILE}" "${MANIFEST_FILE}" "${META_DIR}/" "${THREADS_DIR}/" || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update DB, slice, monthly meta, and per-post threads"

          for i in 1 2 3; do
            if git push origin "${BRANCH}"; then
              echo "Push succeeded."
              exit 0
            fi
            echo "Push failed (attempt $i). Rebasing and retrying..."
            git fetch origin "${BRANCH}"
            git pull --rebase origin "${BRANCH}" || (git rebase --abort && git pull --no-rebase origin "${BRANCH}")
          done

          echo "Push failed after retries."
          exit 1

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: r-programmatic-outputs
          path: |
            ${{ env.DB_FILE }}
            ${{ env.SLICE_FILE }}
            ${{ env.MANIFEST_FILE }}
            ${{ env.META_DIR }}/*.json
            ${{ env.THREADS_DIR }}/*.json
          retention-days: 3
